(()=>{"use strict";(()=>{const e={ESCAPE:"Escape",ENTER:"Enter"};window.util={getRandomData:e=>e[Math.floor(Math.random()*e.length)],getRandomNumber:e=>[Math.floor(Math.random()*e.length)],getRandomInRange:(e,o)=>Math.floor(Math.random()*(o-e+1))+e,shuffleArray:e=>{const o=[...e];for(let e=o.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1)),n=o[e];o[e]=o[t],o[t]=n}return o},onPopupEscPress:o=>{o.key===e.ESCAPE&&(o.preventDefault(),window.map.removeActiveCard())},onPopupMessageEscPress:o=>{o.key===e.ESCAPE&&(o.preventDefault(),window.reset.removeMessageElement())},MouseButtons:{MAIN:0},KeyboardKeys:e}})(),(()=>{const e=document.querySelector(".map"),o=e.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),n=e=>{const o=t.cloneNode(!0);return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-35+"px",o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={mapNode:e,mapPinsNode:o,createNodeFragment:e=>{const o=document.createDocumentFragment();for(let t=0;t<e.length;t++)o.appendChild(n(e[t]));return o},removePins:()=>{const e=window.pin.mapPinsNode.querySelectorAll(".map__pin:not(.map__pin--main)");for(let o of e)o.parentNode.removeChild(o)}}})(),(()=>{const e=document.querySelector(".map__pin--main");window.map={mapPinMain:e,initPinsScreen:e=>{const o=window.pin.createNodeFragment(e);window.pin.mapPinsNode.appendChild(o)},removeActiveCard:()=>{const e=window.pin.mapNode.querySelector(".map__card");e&&(e.parentNode.removeChild(e),document.removeEventListener("keydown",window.util.onPopupEscPress),e.classList.remove(".map__pin--active"))}}})(),(()=>{const e=window.pin.mapNode.querySelector(".map__filters-container"),o=e.querySelector(".map__filters"),t=document.querySelector(".ad-form");let n=!1;const r=()=>{n=!n;const e=n?"add":"remove";Array.from(t.children).forEach((o=>{o.disabled=n,o.classList[e]("disable-cursor")})),Array.from(o.children).forEach((o=>{o.disabled=n,o.classList[e]("disable-cursor")}))},i=e=>{window.pin.mapNode.classList.remove("map--faded"),window.form.formNode.classList.remove("ad-form--disabled"),r(),window.form.passAddressInput(window.move.MainPinSize.pin.WIDTH,window.move.MainPinSize.pin.HEIGHT),window.map.initPinsScreen(e),window.filter.updateSimillarPins(e);const t=window.debounce.debounce((()=>{window.filter.updateSimillarPins(e)}));o.addEventListener("change",t)},a=e=>{e.button!==window.util.MouseButtons.MAIN&&e.key!==window.util.KeyboardKeys.ENTER||(e.preventDefault(),window.backend.load(i),window.map.mapPinMain.removeEventListener("mousedown",a),window.map.mapPinMain.removeEventListener("keydown",a))};window.activate={toggleDisabledOnFormNodes:r,onPinMainClickOrEnterPress:a,mapFilterContainerNode:e,formFiltersNode:o}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",o="https://21.javascript.pages.academy/keksobooking",t={ОК:200},n=document.querySelector("#error").content.querySelector(".error"),r=e=>{const o=n.cloneNode(!0);o.querySelector(".error__message").textContent=e,window.reset.mainNode.appendChild(o),document.addEventListener("keydown",window.util.onPopupMessageEscPress),o.addEventListener("click",window.reset.removeMessageElement)},i=(e,o,n,i)=>{let a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(()=>{a.status===t.ОК?n(a.response):r(`При обращению к серверу произошла ошибка. Статус ответа: ${a.status} ${a.statusText}. Попробуйте перезагрузить страницу`)})),a.addEventListener("error",(()=>{r(`Произошла ошибка соединения. Статус ответа: ${a.status} ${a.statusText}. Попробуйте перезагрузить страницу`)})),a.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${a.timeout}мс. Статус ответа: ${a.status} ${a.statusText}. Попробуйте перезагрузить страницу`)})),a.open(e,o),a.timeout=1e4,a.send("GET"===e?"":i)};window.backend={load:o=>{i("GET",e,o)},upload:(e,t)=>{i("POST",o,t,e)},showError:r,StatusCode:t}})(),window.debounce={debounce:e=>{let o=null;return(...t)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...t)}),500)}}},(()=>{const e="any",o=Array.from(window.activate.formFiltersNode.features);window.filter={updateSimillarPins:t=>{const n=t.concat(),r=e=>{switch(window.activate.formFiltersNode["housing-price"].value){case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return n}},i=n.filter((o=>window.activate.formFiltersNode["housing-type"].value===e?n:o.offer.type===window.activate.formFiltersNode["housing-type"].value)).filter((o=>window.activate.formFiltersNode["housing-rooms"].value===e?n:parseInt(o.offer.rooms,10)===parseInt(window.activate.formFiltersNode["housing-rooms"].value,10))).filter((o=>window.activate.formFiltersNode["housing-guests"].value===e?n:parseInt(o.offer.guests,10)===parseInt(window.activate.formFiltersNode["housing-guests"].value,10))).filter(r).filter(r).filter((function(e){return!o.some((function(o){return o.checked&&!e.offer.features.includes(o.value)}))})).slice(0,5);window.map.removeActiveCard(),window.pin.removePins(),window.map.initPinsScreen(i),window.card.addCardNode(i)}}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",palace:"Замок",house:"Дом"},o=document.querySelector("#card").content.querySelector(".map__card"),t=t=>{const n=document.createDocumentFragment();return n.appendChild((t=>{const n=o.cloneNode(!0);n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").textContent=t.offer.price+" ₽/ночь",n.querySelector(".popup__type").textContent=e[t.offer.type],n.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,n.querySelector(".popup__description").textContent=t.offer.description,n.querySelector(".popup__avatar").src=t.author.avatar;const r=n.querySelector(".popup__photos"),i=r.querySelector(".popup__photo"),a=document.createDocumentFragment();r.removeChild(i);for(let e=0;e<t.offer.photos.length;e++)a.appendChild(i.cloneNode(!0)).src=t.offer.photos[e];r.appendChild(a);const s=n.querySelector(".popup__features").querySelectorAll(".popup__feature"),d=t.offer.features;for(let e=0;e<s.length;e++){let o=s[e],t=o.className.replace("popup__feature popup__feature--","");d.includes(t)||o.remove()}return n})(t)),n};window.card={createСardFragment:t,addCardNode:e=>{let o=window.pin.mapPinsNode.querySelectorAll(".map__pin:not(.map__pin--main)");o.forEach(((n,r)=>{n.addEventListener("click",(()=>{o.forEach((e=>{e.classList.remove(".map__pin--active")})),window.map.removeActiveCard();const i=t(e[r]);i.querySelector(".popup__close").addEventListener("click",window.map.removeActiveCard),document.addEventListener("keydown",window.util.onPopupEscPress),window.pin.mapNode.insertBefore(i,window.activate.mapFiltersNode),n.classList.add(".map__pin--active")}))}))}}})(),(()=>{const e={CIRCLE:{WIDTH:62,HEIGHT:62},PIN:{WIDTH:62,HEIGHT:84}},o=630-e.PIN.HEIGHT,t=130-e.PIN.HEIGHT,n=window.pin.mapNode.offsetWidth-e.PIN.WIDTH/2,r=-e.PIN.WIDTH/2;window.map.mapPinMain.addEventListener("mousedown",(e=>{e.preventDefault();let i={x:e.clientX,y:e.clientY};const a=e=>{e.preventDefault();let a=i.x-e.clientX,s=i.y-e.clientY;const d=window.map.mapPinMain.offsetLeft-a,c=window.map.mapPinMain.offsetTop-s;i={x:e.clientX,y:e.clientY},d>=r&&d<=n&&(window.map.mapPinMain.style.left=d+"px"),c>=t&&c<=o&&(window.map.mapPinMain.style.top=c+"px"),window.form.passAddressInput()},s=e=>{e.preventDefault(),window.pin.mapPinsNode.removeEventListener("mousemove",a),window.pin.mapPinsNode.removeEventListener("mouseup",s)};window.pin.mapPinsNode.addEventListener("mousemove",a),document.addEventListener("mouseup",s)})),window.move={mainPinSize:e}})(),(()=>{const e=document.querySelector("main"),o=document.querySelector("#success").content.querySelector(".success"),t="570px",n="375px",r=()=>{const o=e.querySelector(".success"),t=e.querySelector(".error");o?(o.parentNode.removeChild(o),document.removeEventListener("keydown",window.util.onPopupMessageEscPress)):(t.parentNode.removeChild(t),document.removeEventListener("keydown",window.util.onPopupMessageEscPress))};window.reset={resetPage:()=>{window.pin.mapNode.classList.add("map--faded"),window.form.formNode.classList.add("ad-form--disabled"),window.activate.toggleDisabledOnFormNodes(),window.pin.removePins(),window.form.formNode.reset(),window.activate.formFiltersNode.reset(),window.map.mapPinMain.style.left=t,window.map.mapPinMain.style.top=n,window.form.passAddressInput(window.move.MainPinSize.circle.WIDTH,window.move.MainPinSize.circle.HEIGHT),window.map.removeActiveCard(),window.images.previewHousing.classList.add("hidden"),window.images.previewHousing.src="",window.images.previewAvatar.src="img/muffin-grey.svg",window.map.mapPinMain.addEventListener("mousedown",window.activate.onPinMainClickOrEnterPress),window.map.mapPinMain.addEventListener("keydown",window.activate.onPinMainClickOrEnterPress)},removeMessageElement:r,mainNode:e,createMessageElement:()=>{const t=o.cloneNode(!0);e.appendChild(t),document.addEventListener("keydown",window.util.onPopupMessageEscPress),t.addEventListener("click",r)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],o=document.querySelector(".ad-form__field input[type=file]"),t=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo img"),i=(o,t)=>{o.addEventListener("change",(()=>{const n=o.files[0],r=n.type.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{t.classList.remove("hidden"),t.src=e.result})),e.readAsDataURL(n)}}))};i(o,t),i(n,r),window.images={previewAvatar:t,previewHousing:r}})()})();